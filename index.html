<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestor de Vivienda</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin: 15px 0; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .no-print { margin-right: 10px; }
    @media print {
      .no-print { display: none; }
      body { margin: 0; }
    }
    .beneficio-positivo { color: green; font-size: 1.2em; }
    .beneficio-negativo { color: red; font-size: 1.2em; }
  </style>
</head>
<body>
  <h1>Gestor de Vivienda</h1>

  <!-- Men√∫ -->
  <button onclick="mostrarApartado('ingresos')">Ingresos</button>
  <button onclick="mostrarApartado('gastos')">Gastos</button>
  <button onclick="mostrarApartado('habitaciones')">Habitaciones</button>
  <button onclick="mostrarApartado('proveedores')">Proveedores</button>
  <button onclick="mostrarApartado('backup')">Backup</button>
  <button onclick="mostrarApartado('resumen')">Resumen</button>

  <!-- INGRESOS -->
  <div id="ingresos" style="display:none;">
    <button onclick="volverMenu()">Volver</button>
    <h2>Ingresos</h2>
    <form id="formIngreso" onsubmit="guardarIngreso(event)">
      <input type="hidden" id="ingresoId">
      <label>Fecha: <input type="date" id="ingresoFecha" required></label><br>
      <label>Periodo:
        <select id="ingresoPeriodo" required>
          <option value="">-- Selecciona --</option>
          <option>Septiembre 2025</option>
          <option>Octubre 2025</option>
          <option>Noviembre 2025</option>
          <option>Diciembre 2025</option>
          <option>Enero 2026</option>
          <option>Febrero 2026</option>
          <option>Marzo 2026</option>
          <option>Abril 2026</option>
          <option>Mayo 2026</option>
          <option>Junio 2026</option>
          <option>Julio 2026</option>
          <option>Agosto 2026</option>
          <option>Septiembre 2026</option>
          <option>Octubre 2026</option>
          <option>Noviembre 2026</option>
          <option>Diciembre 2026</option>
          <option>Enero 2027</option>
        </select>
      </label><br>
      <label>Nombre: <input type="text" id="ingresoNombre"></label><br>
      <label>Habitaci√≥n (opcional):
        <select id="ingresoHabitacion" onchange="autocompletarNombreInquilino()">
          <option value="">-- Ninguna --</option>
          <option>Habitaci√≥n 01</option>
          <option>Habitaci√≥n 02</option>
          <option>Habitaci√≥n 03</option>
          <option>Habitaci√≥n 04</option>
          <option>Habitaci√≥n 05</option>
        </select>
      </label><br>
      <label>Concepto:
        <select id="ingresoConcepto">
          <option>Fianza</option>
          <option>Alquiler</option>
          <option>Otro</option>
        </select>
      </label><br>
      <label>Cantidad: <input type="number" id="ingresoCantidad" required></label><br>
      <button type="submit">Guardar</button>
    </form>
    <ul id="listaIngresos"></ul>
  </div>

  <!-- GASTOS -->
  <div id="gastos" style="display:none;">
    <button onclick="volverMenu()">Volver</button>
    <h2>Gastos</h2>
    <form id="formGasto" onsubmit="guardarGasto(event)">
      <input type="hidden" id="gastoId">
      <label>Fecha: <input type="date" id="gastoFecha" required></label><br>
      <label>Concepto:
        <select id="gastoConcepto" onchange="autocompletarProveedorPorConcepto()">
          <option value="">-- Selecciona --</option>
          <option>Electricidad</option>
          <option>Gas</option>
          <option>Agua</option>
          <option>Internet</option>
          <option>Comunidad</option>
          <option>Otros</option>
        </select>
      </label><br>
      <label>Proveedor (opcional):
        <select id="gastoProveedor"></select>
      </label><br>
      <label>Habitaci√≥n (opcional):
        <select id="gastoHabitacion">
          <option value="">-- Ninguna --</option>
          <option>Habitaci√≥n 01</option>
          <option>Habitaci√≥n 02</option>
          <option>Habitaci√≥n 03</option>
          <option>Habitaci√≥n 04</option>
          <option>Habitaci√≥n 05</option>
        </select>
      </label><br>
      <label>Notas: <input type="text" id="gastoNotas"></label><br>
      <label>Cantidad: <input type="number" id="gastoCantidad" required></label><br>
      <button type="submit">Guardar</button>
    </form>
    <ul id="listaGastos"></ul>
  </div>

  <!-- HABITACIONES -->
  <div id="habitaciones" style="display:none;">
    <button onclick="volverMenu()">Volver</button>
    <h2>Habitaciones</h2>
    <form id="formHabitacion" onsubmit="guardarHabitacion(event)">
      <input type="hidden" id="habId">
      <label>Nombre: <input type="text" id="habNombre" required></label><br>
      <label>DNI: <input type="text" id="habDNI" required></label><br>
      <label>M√≥vil: <input type="tel" id="habMovil" required></label><br>
      <label>Nacionalidad: <input type="text" id="habNacionalidad" required></label><br>
      <label>Habitaci√≥n:
        <select id="habHabitacion">
          <option>Habitaci√≥n 01</option>
          <option>Habitaci√≥n 02</option>
          <option>Habitaci√≥n 03</option>
          <option>Habitaci√≥n 04</option>
          <option>Habitaci√≥n 05</option>
        </select>
      </label><br>
      <label>Entrada: <input type="date" id="habEntrada" required></label><br>
      <label>Salida: <input type="date" id="habSalida" required></label><br>
      <button type="submit">Guardar</button>
    </form>
    <ul id="listaHabitaciones"></ul>
  </div>

  <!-- PROVEEDORES -->
  <div id="proveedores" style="display:none;">
    <button onclick="volverMenu()">Volver</button>
    <h2>Proveedores</h2>
    <form id="formProveedor" onsubmit="guardarProveedor(event)">
      <input type="hidden" id="provId">
      <label>Nombre: <input type="text" id="provNombre" required></label><br>
      <label>Concepto:
        <select id="provConcepto" required>
          <option>Comunidad</option>
          <option>Electricidad</option>
          <option>Gas</option>
          <option>Agua</option>
          <option>Internet</option>
          <option>Otros</option>
        </select>
      </label><br>
      <label>Usuario: <input type="text" id="provUsuario" required></label><br>
      <label>Contrase√±a: <input type="text" id="provPassword" required></label><br>
      <label>Correo: <input type="email" id="provCorreo" required></label><br>
      <button type="submit">Guardar</button>
    </form>
    <ul id="listaProveedores"></ul>
  </div>

  <!-- BACKUP -->
  <div id="backup" style="display:none;">
    <button onclick="volverMenu()">Volver</button>
    <h2>Backup</h2>
    <button onclick="exportarBackup()">Exportar Backup</button>
    <input type="file" id="importFile" onchange="importarBackup(event)">
  </div>

  <!-- RESUMEN -->
  <div id="resumen" style="display:none;">
    <button onclick="volverMenu()" class="no-print">Volver</button>
    <button onclick="imprimirResumen()" class="no-print">üñ®Ô∏è Imprimir/Exportar Resumen</button>
    <h2>Resumen Financiero</h2>

    <h3>üìà Ingresos por Habitaci√≥n</h3>
    <table>
      <thead>
        <tr>
          <th>Habitaci√≥n</th>
          <th>Total</th>
          <th>Fianzas</th>
          <th>Alquileres</th>
        </tr>
      </thead>
      <tbody id="tablaIngresosHabitacion">
        <!-- Se llenar√° con JS -->
      </tbody>
    </table>

    <!-- ‚úÖ NUEVOS CAMPOS -->
    <h4><strong>Total Fianzas:</strong> <span id="totalFianzas">0.00‚Ç¨</span></h4>
    <h4><strong>Total Alquileres:</strong> <span id="totalAlquileres">0.00‚Ç¨</span></h4>

    <h4><strong>Total General de Ingresos:</strong> <span id="totalIngresosGeneral">0.00‚Ç¨</span></h4>

    <h3>üìâ Gastos por Concepto</h3>
    <table>
      <thead>
        <tr>
          <th>Concepto</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="tablaGastosConcepto">
        <!-- Se llenar√° con JS -->
      </tbody>
    </table>

    <h4><strong>Total General de Gastos:</strong> <span id="totalGastosGeneral">0.00‚Ç¨</span></h4>

    <h3>‚úÖ Beneficio Neto: <strong id="beneficioNeto" class="beneficio-positivo">0.00‚Ç¨</strong></h3>
  </div>

  <script>
    let datos = { ingresos: [], gastos: [], habitaciones: [], proveedores: [] };

    function mostrarApartado(id) {
      document.querySelectorAll("div").forEach(d => d.style.display = "none");
      document.getElementById(id).style.display = "block";
      if (id === "gastos") {
        actualizarProveedoresSelect();
      }
      if (id === "resumen") {
        calcularResumen(); // ‚úÖ Recalcula y muestra TODO
      }
    }

    function volverMenu() {
      document.querySelectorAll("div").forEach(d => d.style.display = "none");
    }

    // ---------------- INGRESOS ----------------
    function guardarIngreso(e) {
      e.preventDefault();
      let id = document.getElementById("ingresoId").value;
      let obj = {
        id: id || Date.now(),
        fecha: document.getElementById("ingresoFecha").value,
        periodo: document.getElementById("ingresoPeriodo").value,
        nombre: document.getElementById("ingresoNombre").value,
        habitacion: document.getElementById("ingresoHabitacion").value,
        concepto: document.getElementById("ingresoConcepto").value,
        cantidad: document.getElementById("ingresoCantidad").value
      };
      if (id) {
        datos.ingresos = datos.ingresos.map(i => i.id == id ? obj : i);
      } else {
        datos.ingresos.push(obj);
      }
      renderIngresos();
      backup();
      e.target.reset();
      document.getElementById("ingresoId").value = "";
    }

    function editarIngreso(id) {
      let i = datos.ingresos.find(x => x.id == id);
      document.getElementById("ingresoId").value = i.id;
      document.getElementById("ingresoFecha").value = i.fecha;
      document.getElementById("ingresoPeriodo").value = i.periodo;
      document.getElementById("ingresoNombre").value = i.nombre;
      document.getElementById("ingresoHabitacion").value = i.habitacion;
      document.getElementById("ingresoConcepto").value = i.concepto;
      document.getElementById("ingresoCantidad").value = i.cantidad;
    }

    function borrarIngreso(id) {
      datos.ingresos = datos.ingresos.filter(i => i.id != id);
      renderIngresos();
      backup();
    }

    function renderIngresos() {
      let ul = document.getElementById("listaIngresos");
      ul.innerHTML = "";
      datos.ingresos.forEach(i => {
        let li = document.createElement("li");
        li.textContent = `${i.fecha} - ${i.periodo} - ${i.nombre} (${i.habitacion}) - ${i.concepto}: ${i.cantidad}‚Ç¨ `;
        li.innerHTML += `<button onclick="editarIngreso(${i.id})">Editar</button>
                         <button onclick="borrarIngreso(${i.id})">Borrar</button>`;
        ul.appendChild(li);
      });
    }

    function autocompletarNombreInquilino() {
      let habitacion = document.getElementById("ingresoHabitacion").value;
      if (!habitacion) {
        document.getElementById("ingresoNombre").value = "";
        return;
      }
      let inquilino = datos.habitaciones.find(h => h.habitacion === habitacion);
      document.getElementById("ingresoNombre").value = inquilino ? inquilino.nombre : "";
    }

    // ---------------- GASTOS ----------------
    function guardarGasto(e) {
      e.preventDefault();
      let id = document.getElementById("gastoId").value;
      let obj = {
        id: id || Date.now(),
        fecha: document.getElementById("gastoFecha").value,
        concepto: document.getElementById("gastoConcepto").value,
        proveedor: document.getElementById("gastoProveedor").value,
        habitacion: document.getElementById("gastoHabitacion").value,
        notas: document.getElementById("gastoNotas").value,
        cantidad: document.getElementById("gastoCantidad").value
      };
      if (id) {
        datos.gastos = datos.gastos.map(g => g.id == id ? obj : g);
      } else {
        datos.gastos.push(obj);
      }
      renderGastos();
      backup();
      e.target.reset();
      document.getElementById("gastoId").value = "";
    }

    function editarGasto(id) {
      let g = datos.gastos.find(x => x.id == id);
      document.getElementById("gastoId").value = g.id;
      document.getElementById("gastoFecha").value = g.fecha;
      document.getElementById("gastoConcepto").value = g.concepto;
      document.getElementById("gastoProveedor").value = g.proveedor;
      document.getElementById("gastoHabitacion").value = g.habitacion;
      document.getElementById("gastoNotas").value = g.notas;
      document.getElementById("gastoCantidad").value = g.cantidad;
    }

    function borrarGasto(id) {
      datos.gastos = datos.gastos.filter(g => g.id != id);
      renderGastos();
      backup();
    }

    function renderGastos() {
      let ul = document.getElementById("listaGastos");
      ul.innerHTML = "";
      datos.gastos.forEach(g => {
        let li = document.createElement("li");
        li.textContent = `${g.fecha} - ${g.concepto} - Prov: ${g.proveedor} - ${g.habitacion} - ${g.notas}: ${g.cantidad}‚Ç¨ `;
        li.innerHTML += `<button onclick="editarGasto(${g.id})">Editar</button>
                         <button onclick="borrarGasto(${g.id})">Borrar</button>`;
        ul.appendChild(li);
      });
    }

    function autocompletarProveedorPorConcepto() {
      let concepto = document.getElementById("gastoConcepto").value;
      if (!concepto) {
        document.getElementById("gastoProveedor").value = "";
        return;
      }
      let proveedor = datos.proveedores.find(p => p.concepto === concepto);
      if (proveedor) {
        document.getElementById("gastoProveedor").value = proveedor.nombre;
      } else {
        document.getElementById("gastoProveedor").value = "";
      }
    }

    // ---------------- HABITACIONES ----------------
    function guardarHabitacion(e) {
      e.preventDefault();
      let id = document.getElementById("habId").value;
      let hab = document.getElementById("habHabitacion").value;
      let obj = {
        id: id || Date.now(),
        nombre: document.getElementById("habNombre").value,
        dni: document.getElementById("habDNI").value,
        movil: document.getElementById("habMovil").value,
        nacionalidad: document.getElementById("habNacionalidad").value,
        habitacion: hab,
        entrada: document.getElementById("habEntrada").value,
        salida: document.getElementById("habSalida").value
      };
      datos.habitaciones = datos.habitaciones.filter(h => h.habitacion != hab);
      datos.habitaciones.push(obj);
      renderHabitaciones();
      backup();
      e.target.reset();
      document.getElementById("habId").value = "";
    }

    function editarHabitacion(id) {
      let h = datos.habitaciones.find(x => x.id == id);
      document.getElementById("habId").value = h.id;
      document.getElementById("habNombre").value = h.nombre;
      document.getElementById("habDNI").value = h.dni;
      document.getElementById("habMovil").value = h.movil;
      document.getElementById("habNacionalidad").value = h.nacionalidad;
      document.getElementById("habHabitacion").value = h.habitacion;
      document.getElementById("habEntrada").value = h.entrada;
      document.getElementById("habSalida").value = h.salida;
    }

    function borrarHabitacion(id) {
      datos.habitaciones = datos.habitaciones.filter(h => h.id != id);
      renderHabitaciones();
      backup();
    }

    function renderHabitaciones() {
      let ul = document.getElementById("listaHabitaciones");
      ul.innerHTML = "";
      datos.habitaciones.forEach(h => {
        let li = document.createElement("li");
        li.textContent = `${h.habitacion} - ${h.nombre} (DNI:${h.dni}, M√≥vil:${h.movil}, Nac:${h.nacionalidad}, Entrada:${h.entrada}, Salida:${h.salida}) `;
        li.innerHTML += `<button onclick="editarHabitacion(${h.id})">Editar</button>
                         <button onclick="borrarHabitacion(${h.id})">Borrar</button>`;
        ul.appendChild(li);
      });
    }

    // ---------------- PROVEEDORES ----------------
    function guardarProveedor(e) {
      e.preventDefault();
      let id = document.getElementById("provId").value;
      let obj = {
        id: id || Date.now(),
        nombre: document.getElementById("provNombre").value,
        concepto: document.getElementById("provConcepto").value,
        usuario: document.getElementById("provUsuario").value,
        password: document.getElementById("provPassword").value,
        correo: document.getElementById("provCorreo").value
      };
      if (id) {
        datos.proveedores = datos.proveedores.map(p => p.id == id ? obj : p);
      } else {
        datos.proveedores.push(obj);
      }
      renderProveedores();
      backup();
      e.target.reset();
      document.getElementById("provId").value = "";
    }

    function editarProveedor(id) {
      let p = datos.proveedores.find(x => x.id == id);
      document.getElementById("provId").value = p.id;
      document.getElementById("provNombre").value = p.nombre;
      document.getElementById("provConcepto").value = p.concepto || "Otros";
      document.getElementById("provUsuario").value = p.usuario || "";
      document.getElementById("provPassword").value = p.password;
      document.getElementById("provCorreo").value = p.correo;
    }

    function borrarProveedor(id) {
      datos.proveedores = datos.proveedores.filter(p => p.id != id);
      renderProveedores();
      backup();
    }

    function renderProveedores() {
      let ul = document.getElementById("listaProveedores");
      ul.innerHTML = "";
      datos.proveedores.forEach(p => {
        let li = document.createElement("li");
        li.textContent = `${p.nombre} - ${p.concepto || "N/A"} - Usuario: ${p.usuario || "N/A"} - ${p.correo}`;
        li.innerHTML += `<button onclick="editarProveedor(${p.id})">Editar</button>
                         <button onclick="borrarProveedor(${p.id})">Borrar</button>`;
        ul.appendChild(li);
      });
      actualizarProveedoresSelect();
    }

    function actualizarProveedoresSelect() {
      let sel = document.getElementById("gastoProveedor");
      sel.innerHTML = "<option value=''>-- Ninguno --</option>";
      datos.proveedores.forEach(p => {
        let opt = document.createElement("option");
        opt.value = p.nombre;
        opt.textContent = p.nombre;
        sel.appendChild(opt);
      });
    }

    // ---------------- BACKUP ----------------
    function backup() {
      localStorage.setItem("gestorVivienda", JSON.stringify(datos));
    }

    function exportarBackup() {
      let ahora = new Date();
      let dia = String(ahora.getDate()).padStart(2, '0');
      let mes = String(ahora.getMonth() + 1).padStart(2, '0');
      let a√±o = ahora.getFullYear();
      let hora = String(ahora.getHours()).padStart(2, '0');
      let minuto = String(ahora.getMinutes()).padStart(2, '0');
      let nombreArchivo = `${dia}-${mes}-${a√±o}-${hora}-${minuto}-backup.json`;

      let blob = new Blob([JSON.stringify(datos)], {type:"application/json"});
      let a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = nombreArchivo;
      a.click();
    }

    function importarBackup(e) {
      let file = e.target.files[0];
      let reader = new FileReader();
      reader.onload = ev => {
        datos = JSON.parse(ev.target.result);
        renderAll();
        backup();
      };
      reader.readAsText(file);
    }

    // ---------------- RESUMEN ----------------
    function calcularResumen() {
      // --- INGRESOS ---
      let habitacionesUnicas = [...new Set(datos.ingresos.map(i => i.habitacion).filter(h => h))];
      let totalIngresosGeneral = 0;
      let totalFianzasGlobal = 0;     // ‚úÖ NUEVO
      let totalAlquileresGlobal = 0;  // ‚úÖ NUEVO
      let tablaIngresos = document.getElementById("tablaIngresosHabitacion");
      tablaIngresos.innerHTML = "";

      let ingresosPorHabitacion = {};
      datos.ingresos.forEach(i => {
        if (!ingresosPorHabitacion[i.habitacion]) {
          ingresosPorHabitacion[i.habitacion] = { total: 0, fianzas: 0, alquileres: 0 };
        }
        let cantidad = parseFloat(i.cantidad) || 0;
        ingresosPorHabitacion[i.habitacion].total += cantidad;
        totalIngresosGeneral += cantidad;

        if (i.concepto === "Fianza") {
          ingresosPorHabitacion[i.habitacion].fianzas += cantidad;
          totalFianzasGlobal += cantidad; // ‚úÖ Acumular global
        } else if (i.concepto === "Alquiler") {
          ingresosPorHabitacion[i.habitacion].alquileres += cantidad;
          totalAlquileresGlobal += cantidad; // ‚úÖ Acumular global
        }
      });

      habitacionesUnicas.forEach(hab => {
        let fila = document.createElement("tr");
        let data = ingresosPorHabitacion[hab];
        fila.innerHTML = `
          <td>${hab}</td>
          <td>${data.total.toFixed(2)}‚Ç¨</td>
          <td>${data.fianzas.toFixed(2)}‚Ç¨</td>
          <td>${data.alquileres.toFixed(2)}‚Ç¨</td>
        `;
        tablaIngresos.appendChild(fila);
      });

      // ‚úÖ MOSTRAR TOTALES NUEVOS
      document.getElementById("totalFianzas").textContent = totalFianzasGlobal.toFixed(2) + "‚Ç¨";
      document.getElementById("totalAlquileres").textContent = totalAlquileresGlobal.toFixed(2) + "‚Ç¨";
      document.getElementById("totalIngresosGeneral").textContent = totalIngresosGeneral.toFixed(2) + "‚Ç¨";

      // --- GASTOS ---
      let conceptosGastos = ["Electricidad", "Gas", "Agua", "Internet", "Comunidad", "Otros"];
      let totalGastosGeneral = 0;
      let gastosPorConcepto = {};
      conceptosGastos.forEach(c => gastosPorConcepto[c] = 0);

      datos.gastos.forEach(g => {
        let cantidad = parseFloat(g.cantidad) || 0;
        if (gastosPorConcepto[g.concepto] !== undefined) {
          gastosPorConcepto[g.concepto] += cantidad;
        } else {
          gastosPorConcepto["Otros"] += cantidad;
        }
        totalGastosGeneral += cantidad;
      });

      let tablaGastos = document.getElementById("tablaGastosConcepto");
      tablaGastos.innerHTML = "";
      conceptosGastos.forEach(concepto => {
        let fila = document.createElement("tr");
        fila.innerHTML = `
          <td>${concepto}</td>
          <td>${gastosPorConcepto[concepto].toFixed(2)}‚Ç¨</td>
        `;
        tablaGastos.appendChild(fila);
      });

      document.getElementById("totalGastosGeneral").textContent = totalGastosGeneral.toFixed(2) + "‚Ç¨";

      // --- BENEFICIO ---
      let beneficio = totalIngresosGeneral - totalGastosGeneral;
      let beneficioElement = document.getElementById("beneficioNeto");
      beneficioElement.textContent = beneficio.toFixed(2) + "‚Ç¨";
      beneficioElement.className = beneficio >= 0 ? "beneficio-positivo" : "beneficio-negativo";
    }

    // ‚úÖ Funci√≥n para imprimir/exportar a PDF (desde navegador)
    function imprimirResumen() {
      window.print();
    }

    // ---------------- INIT ----------------
    function renderAll() {
      renderIngresos();
      renderGastos();
      renderHabitaciones();
      renderProveedores();
    }

    window.onload = () => {
      let d = localStorage.getItem("gestorVivienda");
      if (d) datos = JSON.parse(d);
      renderAll();
    };
  </script>
</body>
</html>
