<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestor Vivienda Compartida (v2)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --ok:#198754; --bad:#dc3545; --bg:#f7f7f8; --card:#ffffff; --ink:#222;
      --muted:#6b7280; --ring:#4CAF50;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#4CAF50;color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 6px rgba(0,0,0,.12)}
    header h1{font-size:18px;margin:0}
    main{padding:16px;max-width:1100px;margin:0 auto}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:600px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
    .btn{appearance:none;border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600}
    .btn:focus{outline:none;box-shadow:0 0 0 3px rgba(76,175,80,.35)}
    .btn.primary{background:#4CAF50;color:#fff;border-color:#4CAF50}
    .stack{display:flex;flex-wrap:wrap;gap:10px}
    .hidden{display:none}
    label{font-size:14px;color:var(--muted);display:block;margin:8px 0 4px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;font:inherit}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--ring);box-shadow:0 0 0 3px rgba(76,175,80,.2)}
    .list{margin:8px 0 0;padding:0;list-style:none}
    .list li{padding:10px 12px;border:1px solid #eef0f3;border-radius:12px;margin:8px 0;background:#fff;display:flex;justify-content:space-between;gap:12px;align-items:center}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#eef0f3}
    .money.in{color:var(--ok);font-weight:700}
    .money.out{color:var(--bad);font-weight:700}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:700px){.two-col{grid-template-columns:1fr}}
    .section-title{margin:0 0 8px;font-size:16px}
    .muted{color:var(--muted);font-size:12px}
    .space{height:8px}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;place-items:center;padding:16px}
    .modal .panel{background:#fff;border-radius:16px;max-width:520px;width:100%;padding:16px}
    .right{text-align:right}
    .danger{color:var(--bad)}
  </style>
</head>
<body>
  <header>
    <h1>Gestor Vivienda Compartida</h1>
    <div class="toolbar">
      <button class="btn" onclick="exportar()">Exportar JSON</button>
      <button class="btn danger" onclick="if(confirm('¬øVaciar todos los datos?')){localStorage.clear();location.reload()}">Vaciar</button>
    </div>
  </header>

  <main>
    <!-- Inicio -->
    <section id="view-home" class="card">
      <h2 class="section-title">Men√∫ principal</h2>
      <div class="grid">
        <button class="btn primary" onclick="go('ingresos')">Ingresos</button>
        <button class="btn primary" onclick="go('gastos')">Gastos</button>
        <button class="btn primary" onclick="go('resumen')">Resumen general</button>
        <button class="btn" onclick="go('habitacion')">Datos habitaci√≥n</button>
        <button class="btn" onclick="go('proveedor')">Datos proveedor</button>
        <button class="btn" onclick="go('buscar')">Buscar</button>
      </div>
    </section>

    <!-- Ingresos -->
    <section id="view-ingresos" class="card hidden">
      <div class="stack">
        <h2 class="section-title">Ingresos</h2>
        <div class="toolbar">
          <button class="btn primary" onclick="openModal('ingreso')">‚ûï Nuevo ingreso</button>
          <button class="btn" onclick="renderListado('ingreso')">üìã Listado</button>
          <button class="btn" onclick="renderTotalesPorHabitacion('ingreso')">üè† Total por habitaci√≥n</button>
          <button class="btn" onclick="renderTotalGlobal('ingreso')">üí∞ Total ingresos</button>
          <button class="btn" onclick="go('home')">‚¨Ö Volver</button>
        </div>
        <ul id="list-ingreso" class="list"></ul>
      </div>
    </section>

    <!-- Gastos -->
    <section id="view-gastos" class="card hidden">
      <div class="stack">
        <h2 class="section-title">Gastos</h2>
        <div class="toolbar">
          <button class="btn primary" onclick="openModal('gasto')">‚ûï Nuevo gasto</button>
          <button class="btn" onclick="renderListado('gasto')">üìã Listado</button>
          <button class="btn" onclick="renderTotalesPorCategoria()">üìÇ Total por categor√≠a</button>
          <button class="btn" onclick="renderTotalGlobal('gasto')">üí∏ Total gastos</button>
          <button class="btn" onclick="go('home')">‚¨Ö Volver</button>
        </div>
        <ul id="list-gasto" class="list"></ul>
      </div>
    </section>

    <!-- Resumen -->
    <section id="view-resumen" class="card hidden">
      <h2 class="section-title">Resumen general</h2>
      <div class="toolbar">
        <button class="btn" onclick="renderBalance()">üìä Balance ingresos y gastos</button>
        <button class="btn" onclick="go('home')">‚¨Ö Volver</button>
      </div>
      <div id="resumen"></div>
    </section>

    <!-- Datos habitaci√≥n -->
    <section id="view-habitacion" class="card hidden">
      <h2 class="section-title">Datos habitaci√≥n</h2>
      <div class="two-col">
        <div>
          <label>Habitaci√≥n</label>
          <select id="sel-hab" onchange="cargarFichaHab()">
            <option value="">‚Äî Elige ‚Äî</option>
            <option>Habitaci√≥n 1</option>
            <option>Habitaci√≥n 2</option>
            <option>Habitaci√≥n 3</option>
            <option>Habitaci√≥n 4</option>
            <option>Habitaci√≥n 5</option>
          </select>
        </div>
      </div>
      <div class="space"></div>
      <form id="form-hab" class="hidden">
        <div class="two-col">
          <div><label>Nombre</label><input name="nombre"></div>
          <div><label>Apellidos</label><input name="apellidos"></div>
          <div><label>N¬∫ DNI</label><input name="dni"></div>
          <div><label>Pa√≠s</label><input name="pais"></div>
          <div><label>Edad</label><input type="number" name="edad" min="0"></div>
          <div><label>Fecha de alta (dd/mm/aaaa)</label><input name="alta" placeholder="dd/mm/aaaa"></div>
          <div><label>Fecha prevista de baja (dd/mm/aaaa)</label><input name="baja" placeholder="dd/mm/aaaa"></div>
          <div><label>Notas</label><textarea name="notas" rows="3"></textarea></div>
          <div><label>Contrato (adjunto)</label><input type="file" name="contrato"></div>
          <div><label>Foto DNI (adjunto)</label><input type="file" name="foto"></div>
        </div>
        <div class="right"><button class="btn primary" type="submit">Guardar datos</button></div>
      </form>
      <div class="toolbar"><button class="btn" onclick="go('home')">‚¨Ö Volver</button></div>
    </section>

    <!-- Datos proveedor -->
    <section id="view-proveedor" class="card hidden">
      <h2 class="section-title">Datos proveedor</h2>
      <form id="form-prov">
        <div class="two-col">
          <div><label>Nombre</label><input name="nombre" required></div>
          <div><label>Correo electr√≥nico</label><input type="email" name="correo" required></div>
          <div><label>Contrase√±a</label><input type="password" name="password" required></div>
          <div style="grid-column:1/-1"><label>Datos contrato</label><textarea name="contrato" rows="4"></textarea></div>
        </div>
        <div class="right"><button class="btn primary" type="submit">Guardar proveedor</button></div>
      </form>
      <div class="toolbar"><button class="btn" onclick="go('home')">‚¨Ö Volver</button></div>
      <ul id="list-prov" class="list"></ul>
    </section>

    <!-- Buscar -->
    <section id="view-buscar" class="card hidden">
      <h2 class="section-title">Buscar</h2>
      <form id="form-buscar" class="two-col">
        <div>
          <label>En</label>
          <select name="coleccion">
            <option value="ingreso">Ingresos</option>
            <option value="gasto">Gastos</option>
          </select>
        </div>
        <div>
          <label>Campo</label>
          <select name="campo">
            <option value="categoria">Categor√≠a</option>
            <option value="importe">Importe</option>
            <option value="fecha">Fecha</option>
            <option value="periodo">Periodo</option>
            <option value="habitacion">Habitaci√≥n</option>
            <option value="notas">Notas</option>
          </select>
        </div>
        <div style="grid-column:1/-1">
          <label>Valor</label>
          <input name="valor" placeholder="Ej.: Alquiler, 250, Enero 2025, Habitaci√≥n 3‚Ä¶">
        </div>
        <div class="right" style="grid-column:1/-1"><button class="btn primary">Buscar</button></div>
      </form>
      <ul id="list-buscar" class="list"></ul>
      <div class="toolbar"><button class="btn" onclick="go('home')">‚¨Ö Volver</button></div>
    </section>
  </main>

  <!-- Modal nueva entrada -->
  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="panel">
      <h3 id="modal-title">Nueva entrada</h3>
      <form id="form-item">
        <div class="two-col">
          <div><label>Fecha</label><input type="date" name="fecha" required></div>
          <div>
            <label>Importe</label>
            <input type="number" name="importe" step="0.01" required>
          </div>
          <div>
            <label>Categor√≠a</label>
            <select name="categoria" id="sel-cat"></select>
          </div>
          <div>
            <label>Asignar a</label>
            <select name="habitacion">
              <option>Habitaci√≥n 1</option><option>Habitaci√≥n 2</option>
              <option>Habitaci√≥n 3</option><option>Habitaci√≥n 4</option>
              <option>Habitaci√≥n 5</option><option>Vivienda</option>
            </select>
          </div>
          <div id="wrap-periodo" class="hidden" style="grid-column:1/-1">
            <label>Periodo</label>
            <select name="periodo" id="sel-periodo"></select>
          </div>
          <div style="grid-column:1/-1">
            <label>Notas</label><input name="notas" placeholder="Obligatorio si categor√≠a = Otros">
          </div>
        </div>
        <div class="right">
          <button type="button" class="btn" onclick="closeModal()">Cancelar</button>
          <button class="btn primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ---------- util ----------
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const LS = {
      get:k => JSON.parse(localStorage.getItem(k)||'[]'),
      set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))
    };

    function go(view){
      $$('.card').forEach(c=>c.classList.add('hidden'));
      const id = {home:'view-home', ingresos:'view-ingresos', gastos:'view-gastos', resumen:'view-resumen', habitacion:'view-habitacion', proveedor:'view-proveedor', buscar:'view-buscar'}[view];
      document.getElementById(id).classList.remove('hidden');
    }

    // ---------- modal nueva entrada ----------
    function monthsRange(years=1){
      const now = new Date(); const items=[];
      const start = new Date(now.getFullYear(),0,1);
      for(let y=0;y<years;y++){
        for(let m=0;m<12;m++){
          const d = new Date(start.getFullYear()+y,m,1);
          const label = d.toLocaleDateString('es-ES',{month:'long', year:'numeric'});
          items.push(label.charAt(0).toUpperCase()+label.slice(1));
        }
      }
      return items;
    }

    function openModal(tipo){
      $('#modal').style.display='grid';
      $('#modal-title').textContent = tipo==='ingreso' ? 'Nuevo ingreso' : 'Nuevo gasto';
      $('#form-item').dataset.tipo = tipo;

      // categor√≠as
      const sel = $('#sel-cat'); sel.innerHTML='';
      if(tipo==='ingreso'){
        ['Fianza','Alquiler'].forEach(c=> sel.innerHTML += `<option>${c}</option>`);
        $('#wrap-periodo').classList.remove('hidden');
        // periodo: 2 a√±os (actual y siguiente)
        const meses = monthsRange(2);
        const sp = $('#sel-periodo'); sp.innerHTML='';
        meses.forEach(m=> sp.innerHTML += `<option>${m}</option>`);
      }else{
        ['Electricidad','Gas','Agua','Internet','Otros'].forEach(c=> sel.innerHTML += `<option>${c}</option>`);
        $('#wrap-periodo').classList.add('hidden');
      }
    }
    function closeModal(){
      $('#modal').style.display='none';
      $('#form-item').reset();
    }

    $('#form-item').addEventListener('submit', e=>{
      e.preventDefault();
      const tipo = e.currentTarget.dataset.tipo;
      const data = Object.fromEntries(new FormData(e.currentTarget).entries());
      if(data.categoria==='Otros' && !data.notas){
        alert("Debes rellenar Notas cuando la categor√≠a es 'Otros'.");
        return;
      }
      // normalizar importe
      data.importe = parseFloat(data.importe||0);
      // guardar
      const arr = LS.get(tipo);
      arr.push(data); LS.set(tipo,arr);
      closeModal();
      renderListado(tipo);
      alert(`${tipo==='ingreso'?'Ingreso':'Gasto'} guardado.`);
    });

    // ---------- listados y totales ----------
    function money(v, tipo){
      const sign = tipo==='ingreso' ? '+' : '-';
      return `<span class="money ${tipo==='ingreso'?'in':'out'}">${sign}${Number(v).toFixed(2)}‚Ç¨</span>`;
    }
    function renderListado(tipo){
      const list = LS.get(tipo);
      const el = document.getElementById(`list-${tipo}`);
      if(list.length===0){ el.innerHTML = '<p class="muted">No hay datos a√∫n.</p>'; return; }
      el.innerHTML = list.map(it=>{
        const per = it.periodo ? `<span class="pill">${it.periodo}</span>`:'';
        return `<li>
          <div>
            <div><strong>${it.categoria}</strong> ${per}</div>
            <div class="muted">${it.fecha} ¬∑ ${it.habitacion} ¬∑ ${it.notas||''}</div>
          </div>
          <div>${money(it.importe, tipo)}</div>
        </li>`;
      }).join('');
    }

    function renderTotalesPorHabitacion(tipo){
      const list = LS.get(tipo);
      const sum = {};
      list.forEach(it=>{
        const key = it.habitacion || 'Sin asignar';
        sum[key] = (sum[key]||0) + Number(it.importe||0);
      });
      const el = document.getElementById(`list-${tipo}`);
      const signo = tipo==='ingreso' ? '+' : '-';
      const cls = tipo==='ingreso' ? 'in' : 'out';
      if(Object.keys(sum).length===0){ el.innerHTML = '<p class="muted">No hay datos.</p>'; return; }
      el.innerHTML = Object.entries(sum).map(([k,v])=>`<li><div><strong>${k}</strong></div><div><span class="money ${cls}">${signo}${v.toFixed(2)}‚Ç¨</span></div></li>`).join('');
    }

    function renderTotalesPorCategoria(){
      const list = LS.get('gasto');
      const sum = {};
      list.forEach(it=>{
        const key = it.categoria || '‚Äî';
        sum[key] = (sum[key]||0) + Number(it.importe||0);
      });
      const el = $('#list-gasto');
      if(Object.keys(sum).length===0){ el.innerHTML = '<p class="muted">No hay datos.</p>'; return; }
      el.innerHTML = Object.entries(sum).map(([k,v])=>`<li><div><strong>${k}</strong></div><div><span class="money out">-${v.toFixed(2)}‚Ç¨</span></div></li>`).join('');
    }

    function renderTotalGlobal(tipo){
      const list = LS.get(tipo);
      const total = list.reduce((a,b)=> a + Number(b.importe||0), 0);
      const el = document.getElementById(`list-${tipo}`);
      el.innerHTML = `<li style="justify-content:center"><div><strong>${tipo==='ingreso'?'Total ingresos':'Total gastos'}</strong></div><div>${money(total, tipo)}</div></li>`;
    }

    function renderBalance(){
      const ins = LS.get('ingreso').reduce((a,b)=> a+Number(b.importe||0), 0);
      const outs = LS.get('gasto').reduce((a,b)=> a+Number(b.importe||0), 0);
      const bal = ins - outs;
      $('#resumen').innerHTML = `
        <div class="two-col">
          <div class="card"><h3>Total ingresos</h3><p class="money in">+${ins.toFixed(2)}‚Ç¨</p></div>
          <div class="card"><h3>Total gastos</h3><p class="money out">-${outs.toFixed(2)}‚Ç¨</p></div>
        </div>
        <div class="card" style="margin-top:12px"><h3>Balance</h3><p style="font-weight:700">${bal.toFixed(2)}‚Ç¨</p></div>`;
    }

    // ---------- datos habitaci√≥n ----------
    function cargarFichaHab(){
      const hab = $('#sel-hab').value;
      const form = $('#form-hab');
      if(!hab){ form.classList.add('hidden'); return; }
      form.classList.remove('hidden');
      const data = JSON.parse(localStorage.getItem('datos-'+hab)||'{}');
      [...form.elements].forEach(el=>{ if(el.name && data[el.name]) el.value = data[el.name]; });
      form.onsubmit = e=>{
        e.preventDefault();
        const newData = Object.fromEntries(new FormData(form).entries());
        localStorage.setItem('datos-'+hab, JSON.stringify(newData));
        alert('Datos guardados para '+hab);
      };
    }

    // ---------- proveedores ----------
    function renderProveedores(){
      const arr = LS.get('proveedor');
      const el = $('#list-prov');
      if(arr.length===0){ el.innerHTML = '<p class="muted">Sin proveedores.</p>'; return; }
      el.innerHTML = arr.map(p=>`<li><div><strong>${p.nombre}</strong><div class="muted">${p.correo}</div></div><div class="pill">contrato</div></li>`).join('');
    }
    $('#form-prov').addEventListener('submit', e=>{
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.currentTarget).entries());
      const arr = LS.get('proveedor'); arr.push(data); LS.set('proveedor',arr);
      e.currentTarget.reset(); renderProveedores(); alert('Proveedor guardado.');
    });
    renderProveedores();

    // ---------- buscar ----------
    $('#form-buscar').addEventListener('submit', e=>{
      e.preventDefault();
      const {coleccion, campo, valor} = Object.fromEntries(new FormData(e.currentTarget).entries());
      const list = LS.get(coleccion);
      const res = list.filter(it=> (it[campo]||'').toString().toLowerCase().includes((valor||'').toLowerCase()));
      const el = $('#list-buscar');
      if(res.length===0){ el.innerHTML = '<p class="muted">Sin resultados.</p>'; return; }
      el.innerHTML = res.map(it=>`<li>
        <div><strong>${it.categoria}</strong> <span class="pill">${it.periodo||'‚Äî'}</span><div class="muted">${it.fecha} ¬∑ ${it.habitacion}</div></div>
        <div>${money(it.importe, coleccion)}</div>
      </li>`).join('');
    });

    // ---------- export ----------
    function exportar(){
      const data = {
        ingresos: LS.get('ingreso'),
        gastos: LS.get('gasto'),
        habitaciones: ['1','2','3','4','5'].map(n=> JSON.parse(localStorage.getItem('datos-Habitaci√≥n '+n)||'{}') ),
        proveedores: LS.get('proveedor')
      };
      const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'vivienda.json';
      a.click();
    }

    // atajos de navegaci√≥n
    go('home');
  </script>
</body>
</html>
